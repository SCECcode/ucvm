#!/bin/bash
## 
## example of running on usc/hpc cluster
##

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
TEST=basin_query_mpi_cvmsi_taper

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

salloc ${UCVM_SALLOC_ENV} -Q --nodes=1 --ntasks=2 --time=00:10:00 srun -Q -o ${TEST}.srun.out ${BIN_DIR}/basin_query_mpi -b ${TEST}.simple -f ${CONF_DIR}/ucvm.conf -m cvmsi,elygtl:taper -i 20 -v 2500 -l 33.25,-119.38 -s 0.1 -x 16 -y 11

od ${TEST}.simple | head -20> $result 2>&1

cat > $expect << EOF_EXPECTED_RESULT
0000000 000000 041772 000000 041772 000000 041734 000000 041772
0000020 000000 042007 000000 042014 000000 042045 000000 042377
0000040 000000 042207 000000 042033 000000 042040 000000 042226
0000060 100000 042242 000000 042076 000000 042002 000000 042007
0000100 000000 042002 000000 041734 000000 041760 000000 042007
0000120 000000 042014 000000 042026 000000 042110 000000 042160
0000140 000000 042026 000000 041734 000000 041760 100000 042223
0000160 000000 042360 100000 042254 000000 042052 000000 042026
0000200 000000 041746 000000 041772 000000 042026 000000 042045
0000220 000000 042052 000000 042052 000000 042033 000000 042014
0000240 000000 041710 000000 041676 000000 041772 000000 042146
0000260 000000 042327 040000 042403 100000 042305 100000 042235
0000300 000000 042007 000000 042040 000000 042226 140000 042612
0000320 100000 042261 000000 042172 000000 042033 000000 042002
0000340 000000 041772 000000 042007 000000 042045 100000 042211
0000360 100000 042312 140000 042443 100000 042447 000000 042353
0000400 000000 042045 000000 042177 000000 042057 000000 042045
0000420 100000 042235 000000 042177 000000 042026 000000 042014
0000440 000000 042071 000000 042264 100000 042261 000000 042233
0000460 140000 042455 040000 042530 100000 042543 000000 042515
EOF_EXPECTED_RESULT

echo "Running examples_programs_basin basin_query_mpi_cvmsi_taper"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi
                               
trap 'rm -f "$expect" "$result"' exit



