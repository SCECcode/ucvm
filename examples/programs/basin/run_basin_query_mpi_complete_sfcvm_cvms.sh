#!/bin/bash
##
## example of running on usc cluster
##

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
TEST=basin_query_mpi_complete_sfcvm_cvms_z2.5x

salloc ${UCVM_SALLOC_ENV} -Q --nodes=1 --ntasks=2 --time=00:10:00 srun -Q -o ${TEST}.srun.out ${BIN_DIR}/basin_query_mpi_complete -b ${TEST}.first,${TEST}.firstOrSecond,${TEST}.last,${TEST}.secondOnly,${TEST}.threeLast -o ${TEST}.result,${TEST}.meta.json -f ${CONF_DIR}/ucvm.conf -m sfcvm,cvms -i 20 -v 2500 -l 35,-122.5 -s 0.1 -x 16 -y 11 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od ${TEST}.first > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000 000000 000000 000000 000000 000000 000000 000000 000000
*
0000120 000000 000000 000000 000000 000000 042160 000000 000000
0000140 000000 000000 000000 000000 000000 000000 000000 000000
*
0000220 000000 000000 000000 042165 000000 042160 000000 042153
0000240 000000 042153 000000 000000 000000 000000 000000 000000
0000260 000000 000000 000000 000000 000000 000000 000000 000000
*
0000320 000000 042165 000000 042160 000000 042160 000000 042153
0000340 000000 042153 000000 042153 000000 042146 000000 000000
0000360 000000 000000 000000 000000 000000 000000 000000 000000
0000400 000000 000000 000000 000000 000000 000000 000000 042172
0000420 000000 042165 000000 042160 000000 042153 000000 042153
0000440 000000 042153 000000 042153 000000 042153 000000 042146
0000460 000000 000000 000000 000000 000000 000000 000000 000000
0000500 000000 000000 000000 000000 000000 042172 000000 042165
0000520 000000 042160 000000 042153 000000 042153 000000 042153
0000540 000000 042153 000000 042153 000000 042146 000000 042146
0000560 000000 042146 000000 042146 000000 000000 000000 000000
0000600 000000 000000 000000 042172 000000 042165 000000 042160
0000620 000000 042153 000000 042153 000000 042153 000000 042153
0000640 000000 042153 000000 042146 000000 042146 000000 042146
0000660 000000 042146 000000 042146 000000 042064 000000 042064
0000700 000000 042165 000000 042165 000000 042165 000000 042160
0000720 000000 042153 000000 042153 000000 042153 000000 042153
0000740 000000 042153 000000 042146 000000 042146 000000 042146
0000760 000000 042076 000000 042064 000000 042057 000000 042064
0001000 000000 042165 000000 042165 000000 042165 000000 042153
0001020 000000 042153 000000 042153 000000 042153 000000 042153
0001040 000000 042153 000000 042146 000000 042146 000000 042064
0001060 000000 042064 000000 042064 000000 042064 000000 042064
0001100 000000 042165 000000 042165 000000 042160 000000 042160
0001120 000000 042153 000000 042153 000000 042153 000000 042153
0001140 000000 042153 000000 042146 000000 042146 000000 042064
0001160 000000 042064 000000 042064 000000 042064 000000 042064
0001200 000000 042165 000000 042165 000000 042160 000000 042153
0001220 000000 042153 000000 042153 000000 042153 000000 042153
0001240 000000 042153 000000 042071 000000 042064 000000 042064
0001260 000000 042064 000000 042064 000000 042064 000000 042064
0001300
EOF_EXPECTED_RESULT

echo "Running examples_programs_basin basin_query_mpi_complete_sfcvm_cvms"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit

