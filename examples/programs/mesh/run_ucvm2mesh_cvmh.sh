#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' small_cvmh.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > small_cvmh.conf

${BIN_DIR}/ucvm2mesh -f small_cvmh.conf > small_cvmh.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od small_cvmh.grid | sed 's/ //g' > $result 2>& 1

if [ "$(uname)" == "Darwin" ]; then
  cat > $expect << EOF_EXPECTED_RESULT
0000000023461144414037776140136074642041450000000040100
0000020000000000000000000000000142601065260037775140136
0000040042624164265177774040077000000000000000000000000
0000060077276006125037774140136050735045431177771040077
0000100000000000000000000000000051345126772037772140136
0000120014052126575177765040077000000000000000000000000
0000140040771047637037771140136114161007740177762040077
0000160000000000000000000000000045770170504037767140136
0000200151274071103177756040077000000000000000000000000
0000220151144134577037775140136011740114107000002040100
0000240000000000000000000000000063372055444037774140136
0000260023353144571000000040100000000000000000000000000
0000300013174176311037772140136026753172526177775040077
0000320000000000000000000000000160353117155037771140136
0000340143777053671177772040077000000000000000000000000
0000360143104040022037770140136016016135035177766040077
0000400000000000000000000000000143212160667037766140136
0000420025036016200177763040077000000000000000000000000
0000440061254124763037774140136120005166545000004040100
0000460000000000000000000000000166610045627037773140136
0000500116363017227000003040100000000000000000000000000
0000520111520166474037771140136073342047711000001040100
0000540000000000000000000000000052005107341037770140136
0000560055641000766177777040077000000000000000000000000
0000600027645030206037767140136101572062131177773040077
0000620000000000000000000000000023061151053037765140136
0000640062523143274177767040077000000000000000000000000
0000660154007115146037773140136017023041204000007040100
0000700000000000000000000000000054451036013037772140136
0000720002345071666000005040100000000000000000000000000
0000740172470156657037770140136144267122347000003040100
0000760000000000000000000000000126062077524037767140136
0001000064611153031000001040100000000000000000000000000
0001020077031020371037766140136163531003512000000040100
0001040000000000000000000000000065352141236037764140136
0001060102122070370177774040077000000000000000000000000
0001100031167105332037772140136107007113642000011040100
0001120000000000000000000000000124737026176037771140136
0001140057276144324000007040100000000000000000000000000
0001160036063147043037767140136006164175006000005040100
0001200000000000000000000000000164564067707037766140136
0001220113451025467000004040100000000000000000000000000
0001240130641010554037765140136177340056150000002040100
0001260000000000000000000000000112270131421037763140136
0001300041624106632000000040100000000000000000000000000
0001320
EOF_EXPECTED_RESULT

else

  cat > $expect << EOF_EXPECTED_RESULT
0000000023461144414037776140136074642041450000000040100
0000020000000000000000000000000142601065260037775140136
0000040042624164265177774040077000000000000000000000000
0000060077276006125037774140136050737045431177771040077
0000100000000000000000000000000051345126772037772140136
0000120014052126575177765040077000000000000000000000000
0000140040771047637037771140136114161007740177762040077
0000160000000000000000000000000045770170504037767140136
0000200151272071103177756040077000000000000000000000000
0000220151144134577037775140136011740114107000002040100
0000240000000000000000000000000063372055444037774140136
0000260023353144571000000040100000000000000000000000000
0000300013174176311037772140136026753172526177775040077
0000320000000000000000000000000160353117155037771140136
0000340143777053671177772040077000000000000000000000000
0000360143104040022037770140136016016135035177766040077
0000400000000000000000000000000143212160667037766140136
0000420025036016200177763040077000000000000000000000000
0000440061254124763037774140136120005166545000004040100
0000460000000000000000000000000166610045627037773140136
0000500116364017227000003040100000000000000000000000000
0000520111520166474037771140136073342047711000001040100
0000540000000000000000000000000052005107341037770140136
0000560055637000766177777040077000000000000000000000000
0000600027645030206037767140136101572062131177773040077
0000620000000000000000000000000023061151053037765140136
0000640062523143274177767040077000000000000000000000000
0000660154007115146037773140136017024041204000007040100
0000700000000000000000000000000054451036013037772140136
0000720002345071666000005040100000000000000000000000000
0000740172470156657037770140136144267122347000003040100
0000760000000000000000000000000126062077524037767140136
0001000064611153031000001040100000000000000000000000000
0001020077031020371037766140136163531003512000000040100
0001040000000000000000000000000065352141236037764140136
0001060102122070370177774040077000000000000000000000000
0001100031167105332037772140136107007113642000011040100
0001120000000000000000000000000124737026176037771140136
0001140057276144324000007040100000000000000000000000000
0001160036063147043037767140136006164175006000005040100
0001200000000000000000000000000164564067707037766140136
0001220113450025467000004040100000000000000000000000000
0001240130641010554037765140136177340056150000002040100
0001260000000000000000000000000112270131421037763140136
0001300041623106632000000040100000000000000000000000000
0001320
EOF_EXPECTED_RESULT

fi

echo "Running examples_programs_ucvm2mesh ucvm2mesh_cvmh"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


