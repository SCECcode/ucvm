#!/bin/bash

if [ -z "$UCVM_INSTALL_PATH" ]; then
  echo "Need to set UCVM_INSTALL_PATH to run >" ${0##*/} 
  exit
fi
source $UCVM_INSTALL_PATH/conf/ucvm_env.sh

BIN_DIR=${UCVM_INSTALL_PATH}/bin
CONF_DIR=${UCVM_INSTALL_PATH}/conf
SCRATCH=./scratch

sed 's ${CONF_DIR} '$CONF_DIR' ' small_cvms5.conf_template | sed 's ${SCRATCH} '$SCRATCH' ' > small_cvms5.conf

${BIN_DIR}/ucvm2mesh -f small_cvms5.conf > small_cvms5.out 2>& 1 

expect=$(mktemp) || exit 1
result=$(mktemp) || (trap 'rm -f "$expect"'; exit 1)

od small_cvms5.grid | sed 's/ //g' > $result 2>& 1

cat > $expect << EOF_EXPECTED_RESULT
0000000125143065102137763140135156026125663063150040101
0000020000000000000000000000000136424072062137745140135
0000040162360026732063126040101000000000000000000000000
0000060026544077057137727140135023050127764063103040101
0000100000000000000000000000000175503104067137711140135
0000120117756030777063061040101000000000000000000000000
0000140023240111115137673140135051170131775063036040101
0000160000000000000000000000000127556116156137655140135
0000200036774032755063014040101000000000000000000000000
0000220044257032326137750140135136477132022063177040101
0000240000000000000000000000000011774037303137732140135
0000260146232033057063155040101000000000000000000000000
0000300036410044274137714140135012130134077063132040101
0000320000000000000000000000000141707051301137676140135
0000340112255035100063110040101000000000000000000000000
0000360124044056323137660140135046711136064063065040101
0000400000000000000000000000000165023063361137642140135
0000420037745037032063043040101000000000000000000000000
0000440104452177535137734140135005206136152063226040101
0000460000000000000000000000000006441004507137717140135
0000500020113037175063204040101000000000000000000000000
0000520167373011474137701140135067167140202063161040101
0000540000000000000000000000000027250016477137663140135
0000560172500041171063137040101000000000000000000000000
0000600146027023515137645140135132327142143063114040101
0000620000000000000000000000000143470030550137627140135
0000640126563043077063072040101000000000000000000000000
0000660065662144730137721140135141702142271063255040101
0000700000000000000000000000000124145151676137703140135
0000720157730043302063233040101000000000000000000000000
0000740041436156661137665140135032135144276063210040101
0000760000000000000000000000000035710163660137647140135
0001000140601045253063166040101000000000000000000000000
0001020111130170673137631140135103573146213063143040101
0001040000000000000000000000000043274175723137613140135
0001060103177047135063121040101000000000000000000000000
0001100170051112106137706140135164306146401063304040101
0001120000000000000000000000000162647117051137670140135
0001140005426047401063262040101000000000000000000000000
0001160034513124031137652140135062730150362063237040101
0001200000000000000000000000000165404131024137634140135
0001220174502051325063215040101000000000000000000000000
0001240175304136034137616140135142607152253063172040101
0001260000000000000000000000000064171143061137600140135
0001300145334053163063150040101000000000000000000000000
0001320
EOF_EXPECTED_RESULT

echo "Running examples_programs_ucvm2mesh ucvm2mesh_cvms5"
if diff $result $expect > /dev/null 2>&1
then
  echo [SUCCESS]
else
  echo [FAILURE]
fi

trap 'rm -f "$expect" "$result"' exit


